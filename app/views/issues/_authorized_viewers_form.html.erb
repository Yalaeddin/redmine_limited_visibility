<%
   if Redmine::Plugin.installed?(:redmine_organizations)
     @current_visibility_roles = Role.joins('LEFT OUTER JOIN organization_roles ON roles.id = organization_roles.role_id')
                       .joins('LEFT OUTER JOIN organization_memberships ON organization_memberships.id = organization_roles.organization_membership_id')
                       .joins('LEFT OUTER JOIN organization_involvements ON organization_involvements.organization_membership_id = organization_memberships.id')
                       .where("#{OrganizationMembership.table_name}.project_id = ? AND #{OrganizationInvolvement.table_name}.user_id IN (?)", @project.id, User.current.id)
                       .visibility_roles.all
   else
     member = Member.find_by_user_id_and_project_id(User.current.id, @project.id)
     # member cannot remove his current roles
     @current_visibility_roles = member.roles.visibility_roles.all if member.present?
   end

    viewers = []
    if @issue.new_record? # create new issue
      if @current_visibility_roles.present? # current user has at least one visibility role
        @current_visibility_roles.each do |r|
          viewers = viewers | r.authorized_viewers.split('|') if r.authorized_viewers
        end
      else # current user has no visibility role (can see all issues)
        viewers = Role.visibility_roles.pluck(:id)
      end
    else # update existing issue
      if @issue && @issue.authorized_viewers.present?
        viewers = @issue.authorized_viewers.split('|').delete_if(&:blank?)
      else
        viewers = Role.visibility_roles.pluck(:id)
      end
    end
    value = viewers.join('|') + '|'
%>

<script>
  $(function() {
    $('#issue-form').submit(function(e) {
      e.preventDefault();
      var form = this;
      if ($('#issue-form .role.involved').length === 0) {
        alert('<%= l('alert_cant_remove_all_visibility_roles') %>');
        return false;
      }else{
        form.submit(); // submit bypassing the jQuery bound event
      }
    });
  })
</script>

<%= render "roles/select_involved_roles", viewers: value %>
